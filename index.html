<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hottest 100 Ballot (Online)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .form-input:focus { --tw-ring-color: #9aafad; }
        .leaderboard-dots {
            flex-grow: 1;
            border-bottom: 2px dotted #dbeafe; /* blue-100 */
            margin: 0 0.5rem;
            position: relative;
            bottom: 4px;
        }
        .tab {
            transition: all 0.2s ease-in-out;
        }
        .tab.active {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            font-weight: 700;
        }
        .small-checkbox {
            width: 1rem;
            height: 1rem;
        }
        .loader {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen py-8 px-4 lg:px-[100px]">
    <!-- Main container for the ballot paper -->
    <div id="app-container" class="bg-white p-8 sm:p-12 rounded-lg shadow-lg w-full">
        <!-- Loading State -->
        <div id="loader" class="flex justify-center items-center h-96">
            <div class="loader"></div>
        </div>
        <!-- Main Content -->
        <div id="main-content" class="hidden">
            <!-- Header Section with Scorecard -->
            <header class="flex flex-col sm:flex-row justify-between items-start mb-4">
                <div class="text-left w-full sm:w-1/2">
                    <h1 class="text-4xl sm:text-5xl font-bold text-blue-800 tracking-tight">Hottest<br>Aussie 100</h1>
                    <div id="player-name-container" class="mt-4"></div>
                </div>
                <div class="w-full sm:w-auto mt-6 sm:mt-0 sm:ml-8 flex-shrink-0">
                    <div class="border-2 border-blue-500 rounded-lg flex w-full sm:w-[400px] mx-auto sm:mx-0">
                        <div class="bg-blue-500 text-white p-4 rounded-l-md w-1/2 flex flex-col items-center justify-center">
                            <h3 class="font-bold text-lg">Your score</h3>
                            <p id="current-player-score" class="text-5xl font-bold">00</p>
                        </div>
                        <div class="bg-white p-4 rounded-r-md w-1/2 text-blue-800">
                            <h3 class="font-bold text-lg text-center mb-2">Leaderboard</h3>
                            <ul id="leaderboard-list" class="text-base space-y-1"></ul>
                        </div>
                    </div>
                </div>
            </header>

            <div id="player-tabs" class="flex flex-wrap border-b-2 border-blue-200 mb-8"></div>
            
            <div id="ballot-view" class="hidden">
                <form id="ballot-form">
                    <div class="pt-2">
                        <h2 class="text-xl font-bold text-blue-800">Your Selections</h2>
                        <p class="text-sm text-blue-600 mb-6">Triple points for song | Single point for same artist other song (only once, removed if your song appear later)<br>Top Ten = x2 | #1 & #100 = x10</p>
                        <div id="selections-grid" class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-6"></div>
                    </div>
                    <div id="bonuses-section" class="mt-10 pt-6 border-t-2 border-blue-200 space-y-6"></div>
                </form>
            </div>

            <div id="scoreboard-view" class="hidden">
                <div id="scoreboard-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, collection, onSnapshot, setDoc, getDocs, writeBatch, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const NAV_ITEMS = ['Scoreboard', 'Peems', 'Shags', 'Grimey', 'Griff'];
        const PLAYER_NAMES = NAV_ITEMS.slice(1);
        const firebaseConfig = {
            apiKey: "AIzaSyDKseMXdKwsRcfem6gi2B7Fd41SjyJDuwo",
            authDomain: "hottest100aust.firebaseapp.com",
            projectId: "hottest100aust",
            storageBucket: "hottest100aust.appspot.com",
            messagingSenderId: "430168985459",
            appId: "1:430168985459:web:22222f249bbcb6532c3f06"
        };
        const appId = 'hottest100-default';

        let currentView = NAV_ITEMS[0];
        let allPlayersData = {};
        let unsubscribeLeaderboard;
        let appInitialized = false;

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('debug');

        const loader = document.getElementById('loader');
        const mainContent = document.getElementById('main-content');
        const leaderboardList = document.getElementById('leaderboard-list');
        const currentPlayerScoreEl = document.getElementById('current-player-score');
        const selectionsGrid = document.getElementById('selections-grid');
        const bonusesSection = document.getElementById('bonuses-section');
        const playerTabsContainer = document.getElementById('player-tabs');
        const playerNameContainer = document.getElementById('player-name-container');
        const ballotView = document.getElementById('ballot-view');
        const scoreboardView = document.getElementById('scoreboard-view');
        const scoreboardGrid = document.getElementById('scoreboard-grid');

        const ICONS = {
            topDecade: `<svg  class="w-6 h-6 text-blue-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentColor" d="M128 0c17.7 0 32 14.3 32 32l0 32 128 0 0-32c0-17.7 14.3-32 32-32s32 14.3 32 32l0 32 48 0c26.5 0 48 21.5 48 48l0 48L0 160l0-48C0 85.5 21.5 64 48 64l48 0 0-32c0-17.7 14.3-32 32-32zM0 192l448 0 0 272c0 26.5-21.5 48-48 48L48 512c-26.5 0-48-21.5-48-48L0 192zm64 80l0 32c0 8.8 7.2 16 16 16l32 0c8.8 0 16-7.2 16-16l0-32c0-8.8-7.2-16-16-16l-32 0c-8.8 0-16 7.2-16 16zm128 0l0 32c0 8.8 7.2 16 16 16l32 0c8.8 0 16-7.2 16-16l0-32c0-8.8-7.2-16-16-16l-32 0c-8.8 0-16 7.2-16 16zm144-16c-8.8 0-16 7.2-16 16l0 32c0 8.8 7.2 16 16 16l32 0c8.8 0 16-7.2 16-16l0-32c0-8.8-7.2-16-16-16l-32 0zM64 400l0 32c0 8.8 7.2 16 16 16l32 0c8.8 0 16-7.2 16-16l0-32c0-8.8-7.2-16-16-16l-32 0c-8.8 0-16 7.2-16 16zm144-16c-8.8 0-16 7.2-16 16l0 32c0 8.8 7.2 16 16 16l32 0c8.8 0 16-7.2 16-16l0-32c0-8.8-7.2-16-16-16l-32 0zm112 16l0 32c0 8.8 7.2 16 16 16l32 0c8.8 0 16-7.2 16-16l0-32c0-8.8-7.2-16-16-16l-32 0c-8.8 0-16 7.2-16 16z"/></svg>`,
            topArtist: `<svg  class="w-6 h-6 text-blue-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentColor" d="M96 96l0 160c0 53 43 96 96 96s96-43 96-96l-80 0c-8.8 0-16-7.2-16-16s7.2-16 16-16l80 0 0-32-80 0c-8.8 0-16-7.2-16-16s7.2-16 16-16l80 0 0-32-80 0c-8.8 0-16-7.2-16-16s7.2-16 16-16l80 0c0-53-43-96-96-96S96 43 96 96zM320 240l0 16c0 70.7-57.3 128-128 128s-128-57.3-128-128l0-40c0-13.3-10.7-24-24-24s-24 10.7-24 24l0 40c0 89.1 66.2 162.7 152 174.4l0 33.6-48 0c-13.3 0-24 10.7-24 24s10.7 24 24 24l72 0 72 0c13.3 0 24-10.7 24-24s-10.7-24-24-24l-48 0 0-33.6c85.8-11.7 152-85.3 152-174.4l0-40c0-13.3-10.7-24-24-24s-24 10.7-24 24l0 24z"/></svg>`,
            undeserving: `<svg  class="w-6 h-6 text-blue-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentColor" d="M254.4 6.6c3.5-4.3 9-6.5 14.5-5.7C315.8 7.2 352 47.4 352 96c0 11.2-1.9 22-5.5 32l5.5 0c35.3 0 64 28.7 64 64c0 19.1-8.4 36.3-21.7 48l13.7 0c39.8 0 72 32.2 72 72c0 23.2-11 43.8-28 57c34.1 5.7 60 35.3 60 71c0 39.8-32.2 72-72 72L72 512c-39.8 0-72-32.2-72-72c0-35.7 25.9-65.3 60-71c-17-13.2-28-33.8-28-57c0-39.8 32.2-72 72-72l13.7 0C104.4 228.3 96 211.1 96 192c0-35.3 28.7-64 64-64l16.2 0c44.1-.1 79.8-35.9 79.8-80c0-9.2-1.5-17.9-4.3-26.1c-1.8-5.2-.8-11.1 2.8-15.4z"/></svg>`,
            joker: `<svg  class="w-6 h-6 text-blue-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentColor" d="M309 106c11.4-7 19-19.7 19-34c0-22.1-17.9-40-40-40s-40 17.9-40 40c0 14.4 7.6 27 19 34L209.7 220.6c-9.1 18.2-32.7 23.4-48.6 10.7L72 160c5-6.7 8-15 8-24c0-22.1-17.9-40-40-40S0 113.9 0 136s17.9 40 40 40c.2 0 .5 0 .7 0L86.4 427.4c5.5 30.4 32 52.6 63 52.6l277.2 0c30.9 0 57.4-22.1 63-52.6L535.3 176c.2 0 .5 0 .7 0c22.1 0 40-17.9 40-40s-17.9-40-40-40s-40 17.9-40 40c0 9 3 17.3 8 24l-89.1 71.3c-15.9 12.7-39.5 7.5-48.6-10.7L309 106z"/></svg>`
        };

        async function setupInitialData() {
            const playersColRef = collection(db, `artifacts/${appId}/public/data/players`);
            const snapshot = await getDocs(playersColRef);
            const existingPlayers = new Set(snapshot.docs.map(d => d.id));
            const batch = writeBatch(db);
            let needsCommit = false;

            PLAYER_NAMES.forEach(name => {
                if (!existingPlayers.has(name)) {
                    needsCommit = true;
                    const playerDocRef = doc(db, `artifacts/${appId}/public/data/players`, name);
                    const defaultPlayerData = {
                        name: name,
                        totalScore: 0,
                        selections: Array.from({ length: 10 }, () => ({ name: '', score: '', artistCorrect: false, songCorrect: false })),
                        bonuses: {
                            topDecade: { name: '', score: '', correct: false },
                            topArtist: { name: '', score: '', correct: false },
                            undeserving: { name: '', score: '', artistCorrect: false, songCorrect: false },
                            joker: { name: '', score: '', artistCorrect: false, songCorrect: false }
                        }
                    };
                    batch.set(playerDocRef, defaultPlayerData);
                }
            });

            if (needsCommit) {
                console.log("Initializing player data in Firestore...");
                await batch.commit();
            }
        }

        function setupListeners() {
            if (unsubscribeLeaderboard) unsubscribeLeaderboard();
            const playersColRef = collection(db, `artifacts/${appId}/public/data/players`);
            unsubscribeLeaderboard = onSnapshot(playersColRef, (snapshot) => {
                snapshot.docs.forEach(doc => {
                    allPlayersData[doc.id] = doc.data();
                });
                renderLeaderboard();
                if (currentView === 'Scoreboard') {
                    renderScoreboard();
                }
                updateCurrentPlayerScore();
            });
        }
        
        function renderLeaderboard() {
            const sortedPlayers = Object.values(allPlayersData).sort((a, b) => (b.totalScore || 0) - (a.totalScore || 0));
            leaderboardList.innerHTML = sortedPlayers.map(p => `
                <li class="flex justify-between items-center">
                    <span>${p.name}</span><span class="leaderboard-dots"></span><span class="font-bold">${p.totalScore || 0}</span>
                </li>`).join('');
        }
        
        function renderTabs() {
            playerTabsContainer.innerHTML = NAV_ITEMS.map(name => `
                <button class="tab py-2 px-4 text-sm sm:text-base rounded-t-lg ${name === currentView ? 'active' : 'text-blue-500 hover:bg-blue-100'}" data-view="${name}">
                    ${name}
                </button>`).join('');
            playerTabsContainer.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => switchView(tab.dataset.view));
            });
        }

        function renderBallot(playerData) {
            let selectionsHtml = '';
            const columns = [[], []];
            playerData.selections.forEach((selection, index) => {
                const html = `<div class="flex items-center space-x-3">
                    <input type="text" placeholder="Enter name..." value="${selection.name || ''}" data-field="selections" data-index="${index}" data-type="name" class="form-input w-full h-12 border-b-2 border-blue-500 focus:border-blue-600 focus:ring-0 focus:outline-none text-lg text-blue-800 placeholder-blue-300">
                    <input type="number" value="${selection.score || ''}" data-field="selections" data-index="${index}" data-type="score" class="form-input w-12 h-12 text-center text-xl font-bold border-2 border-blue-500 rounded-md focus:ring-2 focus:ring-blue-500">
                </div>`;
                columns[index < 5 ? 0 : 1].push(html);
            });
            selectionsGrid.innerHTML = columns.map(col => `<div class="space-y-6">${col.join('')}</div>`).join('');

            const bonusFields = [
                { id: 'topDecade', label: 'Top Decade', desc: 'Decade with most entries in 100 (10 points)', placeholder: 'e.g., 2010s' },
                { id: 'topArtist', label: 'Top Artist', desc: 'Artist with most entries in 100 (10 points)', placeholder: 'Enter artist name...' },
                { id: 'undeserving', label: 'Undeserving Entrant', desc: "It'll get in, but it shouldn't (double points)", placeholder: 'Enter song name...' },
                { id: 'joker', label: 'Joker', desc: "Play your joker at any time before song #10 is announced. (x2 and x10 multipliers don't apply)", placeholder: 'Enter song name...' }
            ];
            bonusesSection.innerHTML = bonusFields.map(field => {
                const bonus = playerData.bonuses[field.id] || { name: '', score: '' };
                return `<div class="flex items-end justify-between space-x-4">
                    <div class="w-full">
                        <label class="text-xl font-bold text-blue-800">${field.label}</label>
                        <p class="text-sm text-blue-600">${field.desc}</p>
                        <input type="text" placeholder="${field.placeholder}" value="${bonus.name || ''}" data-field="bonuses" data-index="${field.id}" data-type="name" class="form-input w-full h-12 border-b-2 border-blue-500 focus:border-blue-600 focus:ring-0 focus:outline-none text-lg text-blue-800 placeholder-blue-300 mt-2">
                    </div>
                    <input type="number" value="${bonus.score || ''}" data-field="bonuses" data-index="${field.id}" data-type="score" class="form-input w-12 h-12 text-center text-xl font-bold border-2 border-blue-500 rounded-md focus:ring-2 focus:ring-blue-500 flex-shrink-0">
                </div>`;
            }).join('');
            
            document.querySelectorAll('#ballot-form input').forEach(input => input.addEventListener('input', handleInputChange));
        }

        function renderScoreboard() {
            scoreboardGrid.innerHTML = PLAYER_NAMES.map(name => {
                const p = allPlayersData[name] || { name, totalScore: 0, selections: [], bonuses: {} };
                const selectionsHeader = `
                    <div class="flex items-center text-sm font-bold text-blue-700 mb-1">
                        <div class="w-[12%] text-center">A</div>
                        <div class="w-[12%] text-center">S</div>
                    </div>
                `;
                return `
                <div class="border border-blue-200 rounded-lg p-4">
                    <h3 class="text-2xl font-bold text-blue-800 text-center">${p.name} - ${p.totalScore || 0}</h3>
                    <div class="mt-4 border-t pt-4">
                        ${selectionsHeader}
                        <ul class="text-sm space-y-1">
                            ${(p.selections || []).map((s, index) => {
                                const isArtistCorrect = s.artistCorrect || false;
                                const isSongCorrect = s.songCorrect || false;
                                const liClasses = isSongCorrect ? 'bg-blue-100 rounded' : '';
                                const spanClasses = (isArtistCorrect || isSongCorrect) ? 'font-bold text-blue-600' : '';
                                return `<li class="flex items-center p-1 ${liClasses}">
                                    <div class="w-[12%] flex justify-center"><input type="checkbox" class="small-checkbox" data-player="${name}" data-index="${index}" data-type="A" ${isArtistCorrect ? 'checked' : ''}></div>
                                    <div class="w-[12%] flex justify-center"><input type="checkbox" class="small-checkbox" data-player="${name}" data-index="${index}" data-type="S" ${isSongCorrect ? 'checked' : ''}></div>
                                    <div class="w-[64%] pl-2 break-words ${spanClasses}">${s.name || '...'}</div>
                                    <div class="w-[12%] text-right pr-2 font-semibold ${spanClasses}">(${s.score || 0})</div>
                                </li>`
                            }).join('')}
                        </ul>
                        <h4 class="font-bold text-blue-700 mt-4 mb-2">Bonuses</h4>
                        <ul class="text-sm space-y-2">
                            ${Object.entries(p.bonuses || {}).map(([key, val]) => {
                                const isCorrect = val.correct || false;
                                const isArtistCorrect = val.artistCorrect || false;
                                const isSongCorrect = val.songCorrect || false;
                                const spanClasses = (isCorrect || isArtistCorrect || isSongCorrect) ? 'font-bold text-blue-600' : '';
                                
                                let checkboxesHtml = '';
                                if (key === 'topDecade' || key === 'topArtist') {
                                    checkboxesHtml = `<div class="w-[12%] flex justify-center"><input type="checkbox" class="small-checkbox" data-player="${name}" data-index="${key}" data-type="bonus_single" ${isCorrect ? 'checked' : ''}></div>`;
                                } else {
                                    checkboxesHtml = `<div class="w-[12%] flex justify-center"><input type="checkbox" class="small-checkbox mr-2" data-player="${name}" data-index="${key}" data-type="bonus_A" ${isArtistCorrect ? 'checked' : ''}></div>
                                                    <div class="w-[12%] flex justify-center"><input type="checkbox" class="small-checkbox" data-player="${name}" data-index="${key}" data-type="bonus_S" ${isSongCorrect ? 'checked' : ''}></div>`;
                                }

                                return `<li class="flex items-center">
                                    <div class="w-8 flex justify-center items-center flex-shrink-0">${ICONS[key]}</div>
                                    <div class="flex items-center w-[24%] ml-2">${checkboxesHtml}</div>
                                    <div class="flex-1 pl-2 break-words ${spanClasses}">${val.name || '...'}</div>
                                    <div class="w-[12%] text-right pr-2 font-semibold ${spanClasses}">(${val.score || 0})</div>
                                </li>`
                            }).join('')}
                        </ul>
                    </div>
                </div>`;
            }).join('');

            scoreboardGrid.querySelectorAll('input[type="checkbox"]').forEach(box => {
                box.addEventListener('change', handleScoreboardCheckboxChange);
            });
        }

        function updateCurrentPlayerScore() {
            const playerData = allPlayersData[currentView];
            if (playerData) {
                currentPlayerScoreEl.textContent = String(playerData.totalScore || 0).padStart(2, '0');
            } else {
                const sortedPlayers = Object.values(allPlayersData).sort((a, b) => (b.totalScore || 0) - (a.totalScore || 0));
                const leaderScore = sortedPlayers.length > 0 ? sortedPlayers[0].totalScore : 0;
                currentPlayerScoreEl.textContent = String(leaderScore || 0).padStart(2, '0');
            }
        }

        function switchView(newView) {
            currentView = newView;
            renderTabs();
            if (newView === 'Scoreboard') {
                playerNameContainer.innerHTML = `<h2 class="text-lg font-bold uppercase text-blue-800">Scoreboard</h2>`;
                scoreboardView.style.display = 'block';
                ballotView.style.display = 'none';
                renderScoreboard();
            } else {
                playerNameContainer.innerHTML = `<input type="text" value="${newView}" class="form-input w-full max-w-xs h-12 border-b-2 border-blue-500 focus:border-blue-600 focus:ring-0 focus:outline-none text-lg text-blue-800 placeholder-blue-300" readonly>`;
                scoreboardView.style.display = 'none';
                ballotView.style.display = 'block';
                renderBallot(allPlayersData[currentView]);
            }
            updateCurrentPlayerScore();
        }
        
        async function handleInputChange(e) {
            const { field, index, type } = e.target.dataset;
            const value = (type === 'score') ? parseInt(e.target.value) || 0 : e.target.value;
            let updatedPlayerData = JSON.parse(JSON.stringify(allPlayersData[currentView]));

            if (field === 'selections') {
                updatedPlayerData.selections[index][type] = value;
            } else {
                if (!updatedPlayerData.bonuses[index]) {
                    updatedPlayerData.bonuses[index] = {};
                }
                updatedPlayerData.bonuses[index][type] = value;
            }
            
            const selectionScores = updatedPlayerData.selections.reduce((sum, item) => sum + (parseInt(item.score) || 0), 0);
            const bonusScores = Object.values(updatedPlayerData.bonuses).reduce((sum, item) => sum + (parseInt(item.score) || 0), 0);
            updatedPlayerData.totalScore = selectionScores + bonusScores;
            
            const playerDocRef = doc(db, `artifacts/${appId}/public/data/players`, currentView);
            await setDoc(playerDocRef, updatedPlayerData);
        }

        async function handleScoreboardCheckboxChange(e) {
            const { player, index, type } = e.target.dataset;
            const isChecked = e.target.checked;
            let updatedPlayerData = JSON.parse(JSON.stringify(allPlayersData[player]));

            if (type === 'A') {
                updatedPlayerData.selections[index].artistCorrect = isChecked;
            } else if (type === 'S') {
                updatedPlayerData.selections[index].songCorrect = isChecked;
            } else if (type === 'bonus_single') {
                updatedPlayerData.bonuses[index].correct = isChecked;
            } else if (type === 'bonus_A') {
                updatedPlayerData.bonuses[index].artistCorrect = isChecked;
            } else if (type === 'bonus_S') {
                updatedPlayerData.bonuses[index].songCorrect = isChecked;
            }

            const playerDocRef = doc(db, `artifacts/${appId}/public/data/players`, player);
            await setDoc(playerDocRef, updatedPlayerData);
        }

        async function main() {
            try {
                console.log("Attempting to sign in...");
                await signInAnonymously(auth);
                console.log("Signed in anonymously. User:", auth.currentUser?.uid);
                
                console.log("Setting up initial data...");
                await setupInitialData();
                
                console.log("Setting up listeners...");
                setupListeners();
                
                console.log("Initializing view...");
                switchView(currentView);
                
                loader.style.display = 'none';
                mainContent.style.display = 'block';
                console.log("App initialized successfully.");

            } catch (error) {
                console.error("Fatal error during initialization:", error);
                loader.innerHTML = `<p class="text-red-500">Error: Could not initialize the application. Please check the console for details.</p>`;
            }
        }

        main();

    </script>
</body>
</html>
